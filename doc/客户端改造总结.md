# 客户端改造总结

## 1. WebSocket 协议封装与对齐

### 协议来源
- 服务端文档：`F:\repositories\qt-server\docs\websocket.md`

### 信封格式（统一）
```json
{
  "type": "AUTH | PROFILE | MESSAGE",
  "action": "枚举动作",
  "request_id": "uuid",
  "data": {}
}
```

### 实现
- 新增协议工具模块：
  - `createRequest(...)`：创建标准请求 JSON（自动生成或使用传入的 `request_id`）
  - `parseEnvelope(...)`：解析并校验信封关键字段
- 登录请求：
  - `type=AUTH`
  - `action=LOGIN`
  - `data={username,password}`
- 消息发送请求：
  - `type=MESSAGE`
  - `action=SEND`
  - `data={conversation_id,content}`
- 会话窗口接收消息时，优先按协议解析；若非规范包则回退显示原始数据。

### 关键文件
- `src/network/protocol.h`
- `src/network/protocol.cpp`
- `src/ui/login/loginwindow.cpp`
- `src/ui/session/sessionwindow.cpp`

---

## 2. 严格登录流程对齐

### 变更前
- WebSocket 连接成功即直接进入主界面。

### 变更后（严格流程）
- 点击登录后生成并记录 `pending request_id`。
- 发送 `AUTH/LOGIN` 请求。
- 仅当收到以下响应时才判定登录成功并进入主界面：
  1. `request_id` 与 pending 请求一致
  2. `type=AUTH` 且 `action=LOGIN`
  3. `data.ok=true`
- 不满足条件则登录失败，留在登录界面并提示。

### 状态字段
- `m_pendingLoginRequestId`
- `m_isLoginPending`

### 关键文件
- `src/ui/login/loginwindow.h`
- `src/ui/login/loginwindow.cpp`

---

## 3. 测试日志窗口

### 目标
- 新增一个专用测试窗口，内部为只读文本框，集中展示日志。

### 实现
- 新增 `LogWindow`（`QTextEdit` 只读）。
- 在 `main.cpp` 安装全局 `qInstallMessageHandler`，将所有 Qt 日志输出到该窗口：
  - `qDebug`
  - `qInfo`
  - `qWarning`
  - `qCritical`
  - `qFatal`
- 保留 stderr 输出，便于终端/IDE 同步查看。
- 在登录和消息链路补充了关键 `qInfo/qWarning` 业务日志。

### 关键文件
- `src/ui/test/logwindow.h`
- `src/ui/test/logwindow.cpp`
- `main.cpp`
- `src/ui/login/loginwindow.cpp`
- `src/ui/session/sessionwindow.cpp`

---

## 4. 构建配置更新

已在 `CMakeLists.txt` 中新增：
- `src/network/protocol.h/.cpp`
- `src/ui/test/logwindow.h/.cpp`
- 对应 include 目录 `src/ui/test`

---

## 5. 当前状态说明

- 当前改动已完成代码层落地。
- 按约定未执行测试/构建，由开发者自行验证。
